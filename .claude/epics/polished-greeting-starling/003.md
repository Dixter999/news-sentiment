---
name: Implement Playwright Forex Factory Scraper
status: open
created: 2025-11-30T10:22:44Z
updated: 2025-11-30T10:22:44Z
github: https://github.com/Dixter999/news-sentiment/issues/5
depends_on: [002]
parallel: false
conflicts_with: []
---

# Task: Implement Playwright Forex Factory Scraper

## Description
Implement the `ForexFactoryScraper` class using Playwright to scrape the Forex Factory economic calendar. Extract all event fields: timestamp, currency, event_name, impact, actual, forecast, previous. Handle pagination and timezone conversion (ET â†’ UTC).

## TDD Requirements
**This project uses Test-Driven Development. You MUST:**
1. RED: Write failing test first (test_scraper.py)
2. GREEN: Write minimal code to make test pass
3. REFACTOR: Clean up code while keeping tests green

See `.claude/rules/tdd.enforcement.md` for complete requirements.

## Acceptance Criteria
- [ ] Scraper navigates to FF calendar URL
- [ ] Extracts all event fields from calendar table
- [ ] Handles date spanning multiple rows correctly
- [ ] Converts ET timezone to UTC
- [ ] Handles "Tentative" and "All Day" time values
- [ ] Parses impact levels (High/Medium/Low) from icons
- [ ] Handles missing/empty values gracefully
- [ ] Supports headless mode (configurable)
- [ ] Rate limiting between page loads

## Technical Details

### File: `src/scraper/ff_scraper.py`

```python
from playwright.sync_api import sync_playwright, Page
from datetime import datetime
from zoneinfo import ZoneInfo
from typing import List, Dict, Optional

class ForexFactoryScraper:
    """Playwright-based scraper for Forex Factory economic calendar."""

    BASE_URL = "https://www.forexfactory.com/calendar"
    ET_TZ = ZoneInfo("America/New_York")
    UTC_TZ = ZoneInfo("UTC")

    def __init__(self, headless: bool = True, timeout: int = 30000):
        self.headless = headless
        self.timeout = timeout

    def scrape_week(self, date: datetime) -> List[Dict]:
        """Scrape events for a specific week."""
        pass

    def scrape_month(self, year: int, month: int) -> List[Dict]:
        """Scrape events for a specific month."""
        pass

    def _parse_calendar_table(self, page: Page) -> List[Dict]:
        """Parse the calendar table and extract events."""
        pass

    def _parse_impact(self, impact_element) -> Optional[str]:
        """Parse impact level from icon class."""
        # Classes: 'high', 'medium', 'low' or colors
        pass

    def _convert_to_utc(self, date_str: str, time_str: str) -> datetime:
        """Convert FF datetime (ET) to UTC."""
        pass

    def _parse_time(self, time_str: str) -> Optional[str]:
        """Handle special time values: 'Tentative', 'All Day', etc."""
        pass
```

### Calendar URL Patterns
```
# Week view
https://www.forexfactory.com/calendar?week=nov24.2025

# Month view
https://www.forexfactory.com/calendar?month=nov.2025
```

### Calendar Table Selectors
```css
.calendar__row          /* Each event row */
.calendar__date         /* Date cell (spans multiple rows) */
.calendar__time         /* Time cell */
.calendar__currency     /* Currency code */
.calendar__impact span  /* Impact icon */
.calendar__event        /* Event name */
.calendar__actual       /* Actual value */
.calendar__forecast     /* Forecast value */
.calendar__previous     /* Previous value */
```

### Timezone Conversion
```python
def _convert_to_utc(self, date_str: str, time_str: str) -> datetime:
    """Convert FF datetime (ET) to UTC.

    Args:
        date_str: "Mon Nov 25" or "Nov 25, 2025"
        time_str: "8:30am" or "Tentative" or "All Day"

    Returns:
        datetime in UTC timezone
    """
    # Parse and combine date + time
    # Apply ET timezone
    # Convert to UTC
```

### Test File: `tests/test_scraper.py`
```python
class TestForexFactoryScraper:
    def test_scrape_extracts_all_fields(self):
        """Scraper extracts all required fields."""

    def test_timezone_conversion_et_to_utc(self):
        """ET timestamps correctly converted to UTC."""

    def test_impact_level_parsing(self):
        """Impact icons parsed as High/Medium/Low."""

    def test_handles_tentative_time(self):
        """'Tentative' time values handled correctly."""

    def test_handles_all_day_events(self):
        """'All Day' events handled correctly."""

    def test_handles_missing_values(self):
        """Missing actual/forecast/previous handled gracefully."""
```

## Dependencies
- [ ] Task 002: Database models for type hints

## Effort Estimate
- Size: M
- Hours: 8
- Parallel: false

## Definition of Done
- [ ] Tests written FIRST (RED phase)
- [ ] Code implemented (GREEN phase)
- [ ] Code refactored (REFACTOR phase)
- [ ] All tests passing
- [ ] Can scrape a week of events
- [ ] Timezone conversion verified
- [ ] Headless mode works
