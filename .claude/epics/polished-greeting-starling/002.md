---
name: Database Schema and SQLAlchemy Models
status: open
created: 2025-11-30T10:22:44Z
updated: 2025-11-30T10:22:44Z
github: https://github.com/Dixter999/news-sentiment/issues/4
depends_on: [001]
parallel: false
conflicts_with: []
---

# Task: Database Schema and SQLAlchemy Models

## Description
Create the database migration for `economic_events` table with `sentiment_score` and `raw_response` columns. Implement SQLAlchemy model with all fields. Set up database connection manager.

## TDD Requirements
**This project uses Test-Driven Development. You MUST:**
1. RED: Write failing test first (test_database.py)
2. GREEN: Write minimal code to make test pass
3. REFACTOR: Clean up code while keeping tests green

See `.claude/rules/tdd.enforcement.md` for complete requirements.

## Acceptance Criteria
- [ ] Migration file creates `economic_events` table
- [ ] Table includes: id, timestamp, currency, event_name, impact, actual, forecast, previous
- [ ] Table includes NEW fields: `sentiment_score` (FLOAT), `raw_response` (JSONB)
- [ ] Proper indexes on timestamp, currency, impact
- [ ] UNIQUE constraint on (timestamp, event_name, currency)
- [ ] SQLAlchemy model maps to table correctly
- [ ] Connection manager handles pooling
- [ ] Migration runs successfully against ai_model database

## Technical Details

### Migration File: `migrations/001_create_events_table.sql`
```sql
CREATE TABLE IF NOT EXISTS economic_events (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    currency VARCHAR(3),
    event_name VARCHAR(255) NOT NULL,
    impact VARCHAR(20),  -- 'High', 'Medium', 'Low'
    actual VARCHAR(50),
    forecast VARCHAR(50),
    previous VARCHAR(50),
    sentiment_score FLOAT,  -- Gemini score (-1.0 to 1.0)
    raw_response JSONB,     -- Full LLM response for debugging
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(timestamp, event_name, currency)
);

CREATE INDEX IF NOT EXISTS idx_economic_events_timestamp ON economic_events(timestamp);
CREATE INDEX IF NOT EXISTS idx_economic_events_currency ON economic_events(currency);
CREATE INDEX IF NOT EXISTS idx_economic_events_impact ON economic_events(impact);
```

### SQLAlchemy Model: `src/database/models.py`
```python
from sqlalchemy import Column, Integer, String, Float, DateTime, JSON
from sqlalchemy.orm import DeclarativeBase
from datetime import datetime

class Base(DeclarativeBase):
    pass

class EconomicEvent(Base):
    __tablename__ = "economic_events"

    id = Column(Integer, primary_key=True)
    timestamp = Column(DateTime(timezone=True), nullable=False)
    currency = Column(String(3))
    event_name = Column(String(255), nullable=False)
    impact = Column(String(20))
    actual = Column(String(50))
    forecast = Column(String(50))
    previous = Column(String(50))
    sentiment_score = Column(Float)  # -1.0 to 1.0
    raw_response = Column(JSON)      # JSONB in PostgreSQL
    created_at = Column(DateTime(timezone=True), default=datetime.utcnow)
    updated_at = Column(DateTime(timezone=True), default=datetime.utcnow, onupdate=datetime.utcnow)

    def to_dict(self) -> dict:
        """Convert model to dictionary for Gemini analysis."""
        return {
            "event_name": self.event_name,
            "currency": self.currency,
            "impact": self.impact,
            "actual": self.actual,
            "forecast": self.forecast,
            "previous": self.previous,
        }
```

### Connection Manager: `src/database/connection.py`
```python
from contextlib import contextmanager
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from .config import get_database_url

engine = create_engine(get_database_url(), pool_size=5, max_overflow=10)
Session = sessionmaker(bind=engine)

@contextmanager
def get_session():
    session = Session()
    try:
        yield session
        session.commit()
    except Exception:
        session.rollback()
        raise
    finally:
        session.close()
```

## Dependencies
- [ ] Task 001: Project structure exists

## Effort Estimate
- Size: S
- Hours: 3
- Parallel: false

## Definition of Done
- [ ] Tests written FIRST (RED phase)
- [ ] Code implemented (GREEN phase)
- [ ] Code refactored (REFACTOR phase)
- [ ] All tests passing
- [ ] Migration runs against database
- [ ] Model CRUD operations work
- [ ] Connection pooling verified
